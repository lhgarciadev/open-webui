# Fase 4.1 - Ejecutar Conexión de Cognitia

## Objetivo
Conectar la aplicación Cognitia (Railway) al nuevo Space de Ollama en Hugging Face.

## Contexto
- Cognitia permanece en Railway
- Solo se cambia la URL de Ollama
- No se requieren cambios de código (solo variable de entorno)

## Prompt de Ejecución

```
Conecta Cognitia al Space de Ollama en Hugging Face:

1. OBTENER URL DEL SPACE:

   # La URL del Space es (reemplaza TU_USUARIO):
   OLLAMA_URL="https://TU_USUARIO-cognitia-ollama.hf.space"

   # Verificar que responde
   curl -s "$OLLAMA_URL/api/tags" | jq

2. OPCIÓN A - VÍA RAILWAY DASHBOARD (Recomendado):

   a) Ir a: https://railway.app/dashboard
   b) Seleccionar proyecto Cognitia
   c) Click en servicio "cognitia" (o el nombre del servicio principal)
   d) Ir a pestaña "Variables"
   e) Buscar o crear: OLLAMA_BASE_URL
   f) Cambiar valor de:
      http://ollama.railway.internal:11434
      a:
      https://TU_USUARIO-cognitia-ollama.hf.space
   g) Click "Save"
   h) El servicio se redesplegará automáticamente

3. OPCIÓN B - VÍA RAILWAY CLI:

   # Instalar Railway CLI si no está instalado
   npm install -g @railway/cli

   # Login
   railway login

   # Ir al proyecto
   cd /Users/juan.quiroga/Desktop/Estudio/MAIN/GIT/open-webui

   # Vincular proyecto (si no está vinculado)
   railway link

   # Actualizar variable
   railway variables set OLLAMA_BASE_URL="https://TU_USUARIO-cognitia-ollama.hf.space"

   # Redesplegar
   railway up

4. ESPERAR REDESPLIEGUE:

   # El redespliegue toma 3-10 minutos
   # Ver progreso en Railway Dashboard

   # O vía CLI:
   railway logs

5. VERIFICAR CONEXIÓN:

   # Una vez desplegado, verificar desde la UI:
   a) Ir a https://cognitia-production.up.railway.app
   b) Iniciar sesión
   c) Ir a Settings > Connections
   d) Verificar que Ollama URL muestra la nueva URL de HF
   e) Los modelos deberían aparecer automáticamente

6. TEST DE CHAT:

   a) Crear nuevo chat
   b) Seleccionar modelo "qwen2.5:7b" o "phi3"
   c) Enviar mensaje de prueba: "Hola, ¿cómo estás?"
   d) Verificar respuesta exitosa
   e) Notar la velocidad (debería ser más rápido)

7. OPCIONAL - AGREGAR HF_TOKEN (para Spaces privados):

   # Solo si el Space es privado
   railway variables set HF_TOKEN="hf_xxxxxxxxxxxx"
   railway up

Entrega:
- Screenshot de variable actualizada en Railway
- Screenshot de Cognitia mostrando modelos de HF
- Respuesta de chat exitosa
```

## Variables de Entorno

| Variable | Valor Anterior | Valor Nuevo |
|----------|----------------|-------------|
| `OLLAMA_BASE_URL` | `http://ollama.railway.internal:11434` | `https://TU_USUARIO-cognitia-ollama.hf.space` |
| `HF_TOKEN` | (nuevo, opcional) | `hf_xxx` (solo si Space privado) |

## Checklist de Ejecución

```
RAILWAY
[ ] Variable OLLAMA_BASE_URL actualizada
[ ] Nuevo valor apunta a HF Space
[ ] Redespliegue iniciado
[ ] Redespliegue completado

COGNITIA
[ ] UI accesible
[ ] Settings > Connections muestra nueva URL
[ ] Modelos de HF visibles en selector
[ ] Chat funciona correctamente

OPCIONAL
[ ] HF_TOKEN agregado (si Space privado)
```

## Troubleshooting

### Modelos no aparecen en Cognitia
```bash
# Verificar que el Space está Running
curl https://TU_USUARIO-cognitia-ollama.hf.space/api/tags

# Si responde con modelos, el problema es la conexión
# Verificar que la URL no tiene / al final
# Correcto: https://user-cognitia-ollama.hf.space
# Incorrecto: https://user-cognitia-ollama.hf.space/

# Reiniciar Cognitia
railway up
```

### Error de conexión
```bash
# Verificar conectividad desde Railway
# Los logs deberían mostrar intentos de conexión

# Si hay error de SSL/TLS:
# Verificar que la URL usa https://

# Si hay timeout:
# El Space puede estar en sleep, esperar 30s
```

### Chat lento o sin respuesta
```bash
# Cold start del Space: esperar 30s
# Cuota ZeroGPU agotada: ver billing en HF
# Modelo muy grande: probar con phi3 (más rápido)
```

## Notas de Seguridad

- La conexión usa HTTPS (cifrada)
- No se exponen credenciales en la URL
- Si el Space es público, cualquiera puede usarlo
- Para uso privado, hacer Space privado + HF_TOKEN

## Tiempo Estimado

| Paso | Tiempo |
|------|--------|
| Actualizar variable | 2-3 min |
| Redespliegue | 3-10 min |
| Verificación | 2-3 min |
| **Total** | **7-16 min** |

## Siguiente Paso

Continuar a [4.2-connect-validar.md](./4.2-connect-validar.md) para validar la conexión.
