# Etapa 4.6 - Ejecutar Sync con Upstream Open WebUI

## Objetivo

Integrar cambios del repositorio oficial open-webui/open-webui preservando customizaciones de Cognitia.

## Contexto

- Documento de referencia: [`../6-upstream-sync.md`](../6-upstream-sync.md)
- Playbook original: `planning/upstream_sync_playbook.md`

## Pre-requisitos

```bash
# Verificar estado limpio
git status
# Debe mostrar "nothing to commit, working tree clean"
# Si hay cambios, commitear primero

# Verificar remotes
git remote -v
# Debe mostrar:
# origin    git@github.com:TU-ORG/open-webui.git
# upstream  https://github.com/open-webui/open-webui.git
```

## Prompt de Ejecucion

```
Ejecuta el sync con upstream de Open WebUI:

1. CONFIGURAR UPSTREAM (si no existe):

   # Verificar remotes actuales
   git remote -v

   # Si no existe upstream, agregarlo
   git remote add upstream https://github.com/open-webui/open-webui.git

   # Verificar que se agrego
   git remote -v

2. FETCH UPSTREAM:

   # Obtener ultimos cambios de upstream
   git fetch upstream

   # Ver cuantos commits hay de diferencia
   git log HEAD..upstream/main --oneline | head -20

3. CREAR BRANCH DE SYNC:

   # Asegurar estar en main actualizado
   git checkout main
   git pull origin main

   # Crear branch de sync con fecha
   git checkout -b sync/upstream-$(date +%Y%m%d)

   # Verificar branch
   git branch

4. MERGE UPSTREAM:

   # Intentar merge
   git merge upstream/main

   # Si hay conflictos, se mostraran
   # Continuar al paso 5 para resolverlos

5. RESOLVER CONFLICTOS (si hay):

   # Ver archivos en conflicto
   git status

   # Para cada archivo, aplicar estas reglas:

   ## MANTENER NUESTRO (branding):
   git checkout --ours src/lib/constants/identity.ts
   git checkout --ours static/favicon.ico
   git checkout --ours static/favicon.png
   git checkout --ours static/logo.png
   git checkout --ours static/splash.png
   git checkout --ours backend/open_webui/static/
   git checkout --ours CLAUDE.md
   git checkout --ours planning/

   ## USAR UPSTREAM (dependencias):
   git checkout --theirs package.json
   git checkout --theirs package-lock.json
   git checkout --theirs backend/requirements.txt

   ## MERGE MANUAL (logica):
   # Para archivos .py, .svelte, .ts que tienen cambios en ambos:
   # Abrir archivo y resolver manualmente
   # Mantener nuestra logica custom
   # Aceptar fixes y features de upstream

   # Despues de resolver, agregar archivos
   git add <archivo-resuelto>

   # Continuar merge cuando todos esten resueltos
   git commit -m "Merge upstream/main into sync branch"

6. RESTAURAR BRANDING:

   # Verificar que identity.ts tiene nuestro branding
   grep "Cognitia" src/lib/constants/identity.ts

   # Verificar que no hay referencias a "Open WebUI" en UI
   grep -r "Open WebUI" src/ --include="*.svelte" | grep -v node_modules

   # Si hay referencias, corregirlas manualmente

7. VERIFICAR BUILD:

   # Instalar dependencias (pueden haber cambiado)
   npm install

   # Verificar tipos
   npm run check

   # Build de produccion
   npm run build

   # Si hay errores, corregir antes de continuar

8. VERIFICAR BACKEND:

   cd backend

   # Instalar dependencias Python
   pip install -r requirements.txt

   # Verificar que importa correctamente
   python -c "from open_webui.main import app; print('Backend OK')"

   cd ..

9. TEST LOCAL:

   # Iniciar backend
   cd backend && ./dev.sh &

   # Iniciar frontend
   npm run dev

   # Verificar en navegador:
   # - Login funciona
   # - Chat funciona
   # - Branding Cognitia visible
   # - Features custom funcionan

10. VERIFICAR COMPLIANCE:

    # Ejecutar script de verificacion
    ./scripts/verify_compliance.sh

    # O manualmente:
    grep -r "Open WebUI" src/ --include="*.svelte" --include="*.ts" | grep -v node_modules

11. FINALIZAR MERGE:

    # Si todo funciona, merge a main
    git checkout main
    git merge sync/upstream-$(date +%Y%m%d)

    # Push a origin
    git push origin main

    # Opcional: tag de sync
    git tag sync-$(date +%Y%m%d)
    git push origin --tags

    # Limpiar branch de sync
    git branch -d sync/upstream-$(date +%Y%m%d)

Entrega:
- Lista de archivos en conflicto y como se resolvieron
- Resultado de npm run build
- Resultado de npm run check
- Screenshot de app funcionando con branding
```

## Archivos Criticos a Preservar

```
# SIEMPRE mantener nuestro version (--ours)
src/lib/constants/identity.ts     # Branding
static/favicon.*                   # Iconos
static/logo.*                      # Logo
static/splash.*                    # Splash
static/apple-touch-icon.png        # PWA
backend/open_webui/static/*        # Assets backend
CLAUDE.md                          # Instrucciones
planning/*                         # Documentacion

# Custom features (merge cuidadoso)
backend/open_webui/tools/presentations.py
src/lib/components/chat/MessageInput/IntegrationsMenu.svelte
```

## Checklist de Ejecucion

```
PREPARACION
[ ] git status limpio
[ ] upstream remote configurado
[ ] En branch main actualizado

SYNC
[ ] git fetch upstream exitoso
[ ] Branch sync creado
[ ] git merge ejecutado
[ ] Conflictos identificados

RESOLUCION
[ ] Archivos de branding preservados
[ ] Conflictos de codigo resueltos
[ ] Features custom intactas

BUILD
[ ] npm install exitoso
[ ] npm run check sin errores
[ ] npm run build exitoso
[ ] Backend inicia correctamente

TEST
[ ] Login funciona
[ ] Chat funciona
[ ] Branding visible
[ ] Presentations funciona

FINALIZACION
[ ] Merge a main completado
[ ] Push a origin exitoso
[ ] Tag creado (opcional)
```

## Tiempo Estimado

| Paso                | Tiempo                           |
| ------------------- | -------------------------------- |
| Preparacion         | 5 min                            |
| Fetch + merge       | 2 min                            |
| Resolver conflictos | 30-120 min (depende de cantidad) |
| Build + test        | 15 min                           |
| Finalizacion        | 5 min                            |
| **Total**           | **1-3 horas**                    |

## Siguiente Paso

Continuar a 4.6-upstream-sync-validar.md
