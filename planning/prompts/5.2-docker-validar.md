# Prompt 5.2 - Verificar Docker Build

> **Etapa**: 5 - Docker Build
> **Tipo**: Validacion
> **Anterior**: [5.1-docker-ejecutar.md](./5.1-docker-ejecutar.md)
> **Siguiente**: [6.1-mcp-ejecutar.md](./6.1-mcp-ejecutar.md)

---

## Prompt

```text
**Rol**: QA de Infraestructura
**Contexto**: Validar que el sistema Docker funciona correctamente

**Tarea**: Verificar build y deployment de Docker

**Pasos**:

1. **Verificar archivos creados**:
   ls -la Dockerfile.whitelabel
   ls -la docker-compose.whitelabel.yaml
   ls -la scripts/build-whitelabel.sh
   ls -la .env.whitelabel.example
   # Todos deben existir

2. **Validar sintaxis de Dockerfile**:
   docker build -f Dockerfile.whitelabel --check .
   # O simplemente intentar build con --dry-run si disponible

3. **Validar docker-compose**:
   docker-compose -f docker-compose.whitelabel.yaml config
   # Debe mostrar configuracion sin errores

4. **Test de build** (puede tomar varios minutos):
   BRAND_NAME="Test Brand" ./scripts/build-whitelabel.sh
   # Debe completar sin errores

5. **Verificar imagen creada**:
   docker images | grep cognitia-ai
   # Debe mostrar la imagen recien creada

6. **Test de ejecucion** (opcional pero recomendado):
   docker-compose -f docker-compose.whitelabel.yaml up -d
   sleep 30
   curl -s http://localhost:3000/health | jq .
   # Debe retornar {"status": true}

   # Verificar branding
   curl -s http://localhost:3000 | grep -i "title"
   # Debe mostrar el nuevo nombre de marca

   # Cleanup
   docker-compose -f docker-compose.whitelabel.yaml down

7. **Verificar variables de entorno en container**:
   docker run --rm local/cognitia-ai:latest env | grep WEBUI_NAME
   # Debe mostrar WEBUI_NAME=Cognitia

**Criterios de exito**:
- [ ] Todos los archivos Docker existen
- [ ] docker-compose config no muestra errores
- [ ] Build completa exitosamente
- [ ] Imagen aparece en docker images
- [ ] Container inicia y responde en /health
- [ ] WEBUI_NAME configurado correctamente

**Si falla**:
- Error de sintaxis: Revisar Dockerfile y docker-compose
- Build falla: Verificar que npm y pip funcionan
- Container no inicia: Revisar logs con docker logs cognitia-ai
```

---

## Comandos de Verificacion

```bash
# 1. Verificar archivos
ls -la Dockerfile.whitelabel docker-compose.whitelabel.yaml scripts/build-whitelabel.sh

# 2. Validar compose
docker-compose -f docker-compose.whitelabel.yaml config

# 3. Build
./scripts/build-whitelabel.sh

# 4. Verificar imagen
docker images | grep -i ai

# 5. Test run
docker-compose -f docker-compose.whitelabel.yaml up -d
sleep 30
curl -s http://localhost:3000/health

# 6. Cleanup
docker-compose -f docker-compose.whitelabel.yaml down
```

## Checklist

### Archivos
- [x] Dockerfile.whitelabel existe (7086 bytes)
- [x] docker-compose.whitelabel.yaml existe (2162 bytes)
- [x] scripts/build-whitelabel.sh existe y es ejecutable (rwxr-xr-x, 2605 bytes)
- [x] env.whitelabel.example existe (2627 bytes)

### Build
- [x] docker-compose config valido (validado 2026-02-12)
- [x] Build completa exitosamente (3.79GB, slim mode)
- [x] Imagen creada: `local/cognitia-ai:latest`

### Runtime
- [x] Container inicia correctamente
- [x] Health check pasa: `{"status": true}`
- [x] WEBUI_NAME=Cognitia verificado en container
- [x] Branding correcto: `<title>Cognitia</title>`

### Contenido Verificado
- [x] Dockerfile.whitelabel: Multi-stage build (Node + Python), BRAND_NAME arg, WEBUI_NAME env
- [x] docker-compose.whitelabel.yaml: Servicios cognitia-ai + ollama, health checks, telemetry disabled
- [x] build-whitelabel.sh: Script ejecutable, configurable via env vars, valida proyecto root
- [x] env.whitelabel.example: Template completo con BRAND_NAME=Cognitia

### Branding
- [x] Sin referencias a "Agentic WebUI" en archivos Docker
- [x] Una referencia a "Open WebUI" en comentario (apropiado - explica origen del código)
- [x] WEBUI_NAME=Cognitia configurado en compose y Dockerfile

## Resultado

| Resultado | Accion |
|-----------|--------|
| **✅ PASS** | Todas las validaciones completadas exitosamente |

**Resumen**: Docker build y runtime funcionan correctamente con branding Cognitia.

## Validacion Ejecutada: 2026-02-13 00:00

### Pasos Completados:
1. **Archivos verificados**: Los 4 archivos existen con tamaños correctos
2. **docker-compose config**: Validación exitosa, configuración correcta
3. **npm issue resuelto**: Regenerado `package-lock.json` con dependencias sincronizadas
4. **Docker build**: Completado exitosamente (imagen 3.79GB en slim mode)
5. **Runtime test**: Containers iniciados, health check pasó
6. **Branding verificado**: `<title>Cognitia</title>` y `WEBUI_NAME=Cognitia`

### Issue Resuelto: npm Dependency Sync

**Problema original**: `npm ci` fallaba con "Missing: picomatch@4.0.3 from lock file"

**Solución aplicada**:
```bash
NPM_CONFIG_CACHE=/tmp/npm-cache npm install --force
```

**Resultado**: `package-lock.json` regenerado con todas las dependencias sincronizadas.

### Proxima Etapa
Continuar a [6.1-mcp-ejecutar.md](./6.1-mcp-ejecutar.md) para configuración MCP
